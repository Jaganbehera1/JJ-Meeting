<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Classroom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --danger-color: #dc2626;
            --success-color: #16a34a;
            --warning-color: #d97706;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        html, body {
            height: 100%;
            overflow: auto;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
        }

        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .header-left h1 {
            font-size: 1.5rem;
            color: var(--text-light);
        }

        .room-info {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .user-info {
            background: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin-right: 1rem;
        }

        /* Main Container */
        .main-container {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem;
            overflow: auto;
            min-height: 400px;
        }

        /* Teacher Section - Only for Students */
        .teacher-section {
            flex: 2;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .teacher-header {
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .teacher-container {
            flex: 1;
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        #teacherVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            display: none;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
        }

        .placeholder-content {
            text-align: center;
            color: var(--text-muted);
        }

        .placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-subtext {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        /* Participants Section - Only for Teacher */
        .participants-section {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .participants-header {
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .participants-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            overflow-y: auto;
            padding: 0.5rem;
            min-height: 200px;
        }

        .participant-card {
            position: relative;
            background: var(--bg-dark);
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .participant-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .participant-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .participant-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b, #334155);
        }

        .participant-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participant-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .participant-status {
            display: flex;
            gap: 0.3rem;
        }

        .status-icon {
            font-size: 0.8rem;
        }

        .status-muted {
            opacity: 0.5;
        }

        .hand-raised {
            color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Controls Footer */
        .controls-footer {
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            padding: 1rem 2rem;
            margin-top: auto;
        }

        .controls-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            align-items: center;
        }

        .control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            padding: 0.8rem 1.5rem;
            background: var(--bg-hover);
            border: none;
            border-radius: 10px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .control-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .control-btn.control-active {
            background: var(--success-color);
        }

        .control-btn.danger {
            background: var(--danger-color);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-btn:disabled:hover {
            background: var(--bg-hover);
            transform: none;
        }

        .control-icon {
            font-size: 1.5rem;
        }

        .control-text {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-header h2 {
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .modal-header p {
            color: var(--text-muted);
        }

        .modal-body {
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-dark);
            color: var(--text-light);
            font-size: 1rem;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .modal-footer {
            text-align: center;
        }

        /* Status Elements */
        .count-badge {
            background: var(--bg-hover);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Scrollbar */
        .participants-grid::-webkit-scrollbar {
            width: 8px;
        }

        .participants-grid::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 4px;
        }

        .participants-grid::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .participants-grid::-webkit-scrollbar-thumb:hover {
            background: #1d4ed8;
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .participants-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                max-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .controls-container {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .control-btn {
                min-width: 80px;
                padding: 0.6rem 1rem;
            }
            
            .control-text {
                font-size: 0.7rem;
            }
            
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>üéì Virtual Classroom</h1>
                <span id="roomInfo" class="room-info">Not connected</span>
            </div>
            <div class="header-right">
                <span id="userInfo" class="user-info">Guest</span>
                <button id="leaveBtn" class="btn btn-danger">Leave Class</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-container">
            <!-- Teacher/Shared Screen Section - Only for Students -->
            <section id="teacherSection" class="teacher-section">
                <div class="teacher-header">
                    <h3 id="teacherTitle">Teacher's Screen</h3>
                </div>
                <div class="teacher-container">
                    <video id="teacherVideo" autoplay playsinline muted></video>
                    <div id="teacherPlaceholder" class="video-placeholder">
                        <div class="placeholder-content">
                            <div class="placeholder-icon">üë®‚Äçüè´</div>
                            <p>Teacher's video will appear here</p>
                            <p class="placeholder-subtext">Waiting for teacher to join...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Participants Grid - Only for Teacher -->
            <section id="participantsSection" class="participants-section">
                <div class="participants-header">
                    <h3>Students <span id="participantsCount" class="count-badge">0</span></h3>
                </div>
                <div id="participantsGrid" class="participants-grid">
                    <!-- Participants will be dynamically added here -->
                </div>
            </section>
        </main>

        <!-- Controls Footer -->
        <footer class="controls-footer">
            <div class="controls-container">
                <button id="videoToggle" class="control-btn control-active">
                    <span class="control-icon">üìπ</span>
                    <span class="control-text">Stop Video</span>
                </button>
                
                <button id="audioToggle" class="control-btn control-active">
                    <span class="control-icon">üé§</span>
                    <span class="control-text">Mute</span>
                </button>
                
                <button id="screenShareBtn" class="control-btn">
                    <span class="control-icon">üñ•Ô∏è</span>
                    <span class="control-text">Share Screen</span>
                </button>
                
                <button id="raiseHandBtn" class="control-btn">
                    <span class="control-icon">‚úã</span>
                    <span class="control-text">Raise Hand</span>
                </button>
            </div>
        </footer>

        <!-- Join Modal -->
        <div id="joinModal" class="modal active">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Join Virtual Classroom</h2>
                    <p>Enter your details to join the class</p>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="userName">Your Name</label>
                        <input type="text" id="userName" placeholder="Enter your full name" maxlength="30" value="Student">
                    </div>
                    
                    <div class="input-group">
                        <label for="userRole">I am a</label>
                        <select id="userRole">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="roomId">Classroom ID</label>
                        <input type="text" id="roomId" placeholder="Enter classroom ID" value="CLASS-001">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="joinClassBtn" class="btn btn-primary btn-large">Join Classroom</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- App Script -->
    <script>
        class VirtualClassroom {
            constructor() {
                this.localStream = null;
                this.screenStream = null;
                this.isVideoOn = true;
                this.isAudioOn = true;
                this.isScreenSharing = false;
                this.isHandRaised = false;
                
                this.userId = this.generateUserId();
                this.userName = '';
                this.userRole = 'student';
                this.roomId = '';
                
                // WebRTC
                this.peers = {};
                this.pendingSignals = new Set();
                this.iceCandidateQueue = new Map();
                this.rtcConfig = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                };
                
                // Track screen sharing state
                this.screenSharingTeacherId = null;
                this.currentTeacherId = null;
                
                // Firebase
                this.db = null;
                
                this.initializeApp();
            }

            generateUserId() {
                return 'user_' + Math.random().toString(36).substr(2, 16);
            }

            initializeApp() {
                this.initializeElements();
                this.setupEventListeners();
                this.initializeFirebase();
            }

            initializeElements() {
                // Video elements
                this.teacherVideo = document.getElementById('teacherVideo');
                this.participantsGrid = document.getElementById('participantsGrid');
                
                // Section elements
                this.teacherSection = document.getElementById('teacherSection');
                this.participantsSection = document.getElementById('participantsSection');
                
                // UI elements
                this.roomInfo = document.getElementById('roomInfo');
                this.userInfo = document.getElementById('userInfo');
                this.participantsCount = document.getElementById('participantsCount');
                this.teacherTitle = document.getElementById('teacherTitle');
                
                // Control buttons
                this.videoToggle = document.getElementById('videoToggle');
                this.audioToggle = document.getElementById('audioToggle');
                this.screenShareBtn = document.getElementById('screenShareBtn');
                this.raiseHandBtn = document.getElementById('raiseHandBtn');
                this.leaveBtn = document.getElementById('leaveBtn');
                
                // Modal elements
                this.joinModal = document.getElementById('joinModal');
                this.userNameInput = document.getElementById('userName');
                this.userRoleSelect = document.getElementById('userRole');
                this.roomIdInput = document.getElementById('roomId');
                this.joinClassBtn = document.getElementById('joinClassBtn');
            }

            setupEventListeners() {
                // Control buttons
                this.videoToggle.addEventListener('click', () => this.toggleVideo());
                this.audioToggle.addEventListener('click', () => this.toggleAudio());
                this.screenShareBtn.addEventListener('click', () => this.toggleScreenShare());
                this.raiseHandBtn.addEventListener('click', () => this.toggleRaiseHand());
                this.leaveBtn.addEventListener('click', () => this.leaveRoom());
                
                // Modal buttons
                this.joinClassBtn.addEventListener('click', () => this.joinRoom());
                this.userNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinRoom();
                });
            }

            initializeFirebase() {
                try {
                    // Firebase configuration
                    const firebaseConfig = {
                        apiKey: "AIzaSyAgZCtcnltf6um5felvWP3r_L1rJt3dEgQ",
                        authDomain: "online-classes-83846.firebaseapp.com",
                        databaseURL: "https://online-classes-83846-default-rtdb.asia-southeast1.firebasedatabase.app",
                        projectId: "online-classes-83846",
                        storageBucket: "online-classes-83846.firebasestorage.app",
                        messagingSenderId: "187976015161",
                        appId: "1:187976015161:web:9b44253a575b011e835ce8",
                        measurementId: "G-8600VC5E8Q"
                    };

                    // Initialize Firebase
                    const app = firebase.initializeApp(firebaseConfig);
                    this.db = firebase.database();
                    console.log('Firebase initialized successfully');
                } catch (error) {
                    console.error('Error initializing Firebase:', error);
                }
            }

            async initializeLocalStream(constraints = null) {
                try {
                    if (!constraints) {
                        constraints = {
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            },
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                autoGainControl: true
                            }
                        };
                    }

                    // Stop existing stream if any
                    if (this.localStream) {
                        this.localStream.getTracks().forEach(track => track.stop());
                    }

                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    return this.localStream;
                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    if (error.name === 'NotReadableError') {
                        alert('Camera or microphone is already in use by another application. Please close other applications using your camera/microphone and try again.');
                    } else if (error.name === 'NotAllowedError') {
                        alert('Camera and microphone permissions are required. Please allow access and try again.');
                    } else {
                        alert('Error accessing camera and microphone: ' + error.message);
                    }
                    throw error;
                }
            }

            async joinRoom() {
                this.userName = this.userNameInput.value.trim();
                this.userRole = this.userRoleSelect.value;
                this.roomId = this.roomIdInput.value.trim();

                if (!this.userName) {
                    alert('Please enter your name');
                    return;
                }

                if (!this.roomId) {
                    alert('Please enter a room ID');
                    return;
                }

                // Check if Firebase is initialized
                if (!this.db) {
                    alert('Firebase is not initialized. Please refresh the page and try again.');
                    return;
                }

                try {
                    await this.initializeLocalStream();
                    
                    // Update UI based on role
                    this.joinModal.classList.remove('active');
                    this.roomInfo.textContent = `Room: ${this.roomId}`;
                    this.userInfo.textContent = `${this.userName} (${this.userRole})`;
                    
                    // Show/hide sections based on role
                    this.updateUIBasedOnRole();
                    
                    // Initialize Firebase data and listeners
                    await this.initializeFirebaseData();
                    this.setupFirebaseListeners();
                    
                    console.log(`Joined room ${this.roomId} as ${this.userName}`);
                    
                } catch (error) {
                    console.error('Error joining room:', error);
                    alert('Error joining room: ' + error.message);
                }
            }

            updateUIBasedOnRole() {
                if (this.userRole === 'teacher') {
                    // Teacher sees only students grid
                    this.teacherSection.style.display = 'none';
                    this.participantsSection.style.display = 'flex';
                } else {
                    // Student sees only teacher's video
                    this.teacherSection.style.display = 'flex';
                    this.participantsSection.style.display = 'none';
                }
            }

            async initializeFirebaseData() {
                if (!this.db) {
                    throw new Error('Firebase database is not available');
                }

                const userRef = this.db.ref(`rooms/${this.roomId}/participants/${this.userId}`);
                
                // Set user data
                await userRef.set({
                    name: this.userName,
                    role: this.userRole,
                    videoEnabled: this.isVideoOn,
                    audioEnabled: this.isAudioOn,
                    screenSharing: this.isScreenSharing,
                    handRaised: this.isHandRaised,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });

                // Set up onDisconnect for user removal
                userRef.onDisconnect().remove();

                // Set up onDisconnect for screen sharing if teacher
                if (this.userRole === 'teacher') {
                    const screenShareRef = this.db.ref(`rooms/${this.roomId}/screenShare`);
                    screenShareRef.onDisconnect().set({
                        active: false
                    });
                }
            }

            setupFirebaseListeners() {
                if (!this.db) {
                    console.error('Firebase database not available for listeners');
                    return;
                }

                // Listen for participants
                this.participantsRef = this.db.ref(`rooms/${this.roomId}/participants`);
                this.participantsRef.on('child_added', (snapshot) => {
                    this.handleParticipantJoined(snapshot);
                });

                this.participantsRef.on('child_changed', (snapshot) => {
                    this.handleParticipantUpdated(snapshot);
                });

                this.participantsRef.on('child_removed', (snapshot) => {
                    this.handleParticipantLeft(snapshot);
                });

                // Listen for WebRTC signals
                this.signalsRef = this.db.ref(`rooms/${this.roomId}/signals`);
                this.signalsRef.on('child_added', (snapshot) => {
                    this.handleSignal(snapshot);
                });

                // Listen for screen sharing
                this.screenShareRef = this.db.ref(`rooms/${this.roomId}/screenShare`);
                this.screenShareRef.on('value', (snapshot) => {
                    this.handleScreenShareUpdate(snapshot);
                });

                // Find current teacher
                this.findCurrentTeacher();
            }

            async findCurrentTeacher() {
                if (!this.participantsRef) return;

                const participantsSnapshot = await this.participantsRef.once('value');
                const participants = participantsSnapshot.val();
                
                if (participants) {
                    for (const [participantId, participantData] of Object.entries(participants)) {
                        if (participantData.role === 'teacher' && participantId !== this.userId) {
                            this.currentTeacherId = participantId;
                            console.log(`Found teacher: ${participantData.name} (${participantId})`);
                            
                            // If student finds teacher, initiate connection
                            if (this.userRole === 'student') {
                                await this.createPeerConnection(participantId, true);
                            }
                            break;
                        }
                    }
                }
            }

            async handleParticipantJoined(snapshot) {
                const participantData = snapshot.val();
                const participantId = snapshot.key;

                if (participantId === this.userId) return;

                console.log(`Participant joined: ${participantData.name}, role: ${participantData.role}`);

                // Update teacher reference if this is a teacher
                if (participantData.role === 'teacher') {
                    this.currentTeacherId = participantId;
                    
                    // Student should connect to teacher
                    if (this.userRole === 'student') {
                        await this.createPeerConnection(participantId, true);
                    }
                }

                // Determine connection type based on roles
                if (this.userRole === 'teacher' && participantData.role === 'student') {
                    // Teacher connecting to student
                    await this.createPeerConnection(participantId, true);
                    this.addParticipantToGrid(participantId, participantData);
                }

                this.updateParticipantsCount();
            }

            handleParticipantUpdated(snapshot) {
                const participantData = snapshot.val();
                const participantId = snapshot.key;

                if (participantId === this.userId) return;

                // Update participant in grid if teacher
                if (this.userRole === 'teacher') {
                    this.updateParticipantInGrid(participantId, participantData);
                }

                // Handle screen sharing updates
                if (participantData.role === 'teacher' && this.userRole === 'student') {
                    if (participantData.screenSharing) {
                        this.teacherTitle.textContent = `${participantData.name} - Screen Sharing`;
                    } else {
                        this.teacherTitle.textContent = `${participantData.name}'s Screen`;
                    }
                }
            }

            handleParticipantLeft(snapshot) {
                const participantId = snapshot.key;
                const participantData = snapshot.val();
                
                // Close peer connection
                this.closePeerConnection(participantId);
                
                // Remove from UI if teacher
                if (this.userRole === 'teacher') {
                    this.removeParticipantFromGrid(participantId);
                }
                
                // If the teacher leaves, clear teacher video and find new teacher
                if (participantData.role === 'teacher') {
                    if (this.userRole === 'student') {
                        this.teacherVideo.srcObject = null;
                        this.teacherTitle.textContent = "Teacher's Screen";
                    }
                    this.currentTeacherId = null;
                    this.findCurrentTeacher();
                }
                
                this.updateParticipantsCount();
            }

            async createPeerConnection(peerId, isInitiator) {
                console.log(`Creating peer connection with ${peerId}, initiator: ${isInitiator}`);
                
                // Close existing connection if any
                if (this.peers[peerId]) {
                    this.closePeerConnection(peerId);
                }

                const peerConnection = new RTCPeerConnection(this.rtcConfig);
                this.peers[peerId] = peerConnection;

                // Initialize ICE candidate queue for this peer
                this.iceCandidateQueue.set(peerId, []);

                // Add current stream tracks
                const currentStream = this.isScreenSharing && this.screenStream ? this.screenStream : this.localStream;
                if (currentStream) {
                    currentStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, currentStream);
                    });
                }

                // Handle incoming stream
                peerConnection.ontrack = (event) => {
                    console.log('Received remote stream from:', peerId);
                    const [remoteStream] = event.streams;
                    this.handleRemoteStream(peerId, remoteStream);
                };

                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        const candidate = event.candidate;
                        if (candidate.candidate && candidate.sdpMid !== null && candidate.sdpMLineIndex !== null) {
                            console.log(`Sending ICE candidate to ${peerId}`);
                            this.sendSignal(peerId, {
                                type: 'ice-candidate',
                                candidate: {
                                    candidate: candidate.candidate,
                                    sdpMid: candidate.sdpMid,
                                    sdpMLineIndex: candidate.sdpMLineIndex
                                }
                            });
                        }
                    }
                };

                // Handle connection state changes
                peerConnection.onconnectionstatechange = () => {
                    console.log(`Connection state with ${peerId}: ${peerConnection.connectionState}`);
                    
                    if (peerConnection.connectionState === 'connected') {
                        console.log(`‚úÖ Successfully connected to ${peerId}`);
                        // Clear ICE candidate queue on successful connection
                        this.iceCandidateQueue.delete(peerId);
                    } else if (peerConnection.connectionState === 'failed') {
                        console.log(`‚ùå Connection with ${peerId} failed`);
                        // Attempt to restart connection after a delay
                        setTimeout(() => {
                            this.restartConnection(peerId);
                        }, 2000);
                    }
                };

                // Create initial offer if initiator
                if (isInitiator) {
                    try {
                        console.log(`Creating initial offer for ${peerId}`);
                        // Small delay to ensure everything is ready
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const offer = await peerConnection.createOffer();
                        await peerConnection.setLocalDescription(offer);
                        
                        this.sendSignal(peerId, {
                            type: 'offer',
                            offer: offer
                        });
                    } catch (error) {
                        console.error('Error creating initial offer:', error);
                    }
                }

                return peerConnection;
            }

    async restartConnection(peerId) {
        console.log(`Restarting connection with ${peerId}`);
        this.closePeerConnection(peerId);
        
        if (!this.db) return;
        
        // Re-fetch participant data
        const participantRef = this.db.ref(`rooms/${this.roomId}/participants/${peerId}`);
        const snapshot = await participantRef.once('value');
        const participantData = snapshot.val();
        
        if (participantData) {
            // Recreate connection with same initiator logic
            const isTeacherToStudent = this.userRole === 'teacher' && participantData.role === 'student';
            const isStudentToTeacher = this.userRole === 'student' && participantData.role === 'teacher';
            
            if (isTeacherToStudent || isStudentToTeacher) {
                await this.createPeerConnection(peerId, true);
            }
        }
    }

    async handleSignal(snapshot) {
        const signalData = snapshot.val();
        const fromUserId = signalData.from;
        
        // Remove signal after processing
        snapshot.ref.remove();

        if (fromUserId === this.userId) return;

        // Check if we've already processed this signal
        const signalKey = `${fromUserId}_${signalData.type}_${signalData.timestamp}`;
        if (this.pendingSignals.has(signalKey)) {
            console.log('Skipping duplicate signal:', signalKey);
            return;
        }

        this.pendingSignals.add(signalKey);
        
        // Clean up old signals
        setTimeout(() => {
            this.pendingSignals.delete(signalKey);
        }, 10000);

        const { type, offer, answer, candidate } = signalData;

        try {
            let peerConnection = this.peers[fromUserId];
            
            if (!peerConnection) {
                // Create a new peer connection for valid role combinations
                if (!this.db) return;
                
                const participantRef = this.db.ref(`rooms/${this.roomId}/participants/${fromUserId}`);
                const snapshot = await participantRef.once('value');
                const participantData = snapshot.val();
                
                if (participantData) {
                    const isTeacherToStudent = this.userRole === 'teacher' && participantData.role === 'student';
                    const isStudentToTeacher = this.userRole === 'student' && participantData.role === 'teacher';
                    
                    if (isTeacherToStudent || isStudentToTeacher) {
                        peerConnection = await this.createPeerConnection(fromUserId, false);
                    }
                }
            }

            if (peerConnection) {
                switch (type) {
                    case 'offer':
                        console.log(`Received offer from ${fromUserId}, current state: ${peerConnection.signalingState}`);
                        
                        if (peerConnection.signalingState === 'stable') {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                            const answerResponse = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answerResponse);
                            
                            this.sendSignal(fromUserId, {
                                type: 'answer',
                                answer: answerResponse
                            });
                            
                            // Process any queued ICE candidates
                            this.processQueuedIceCandidates(fromUserId, peerConnection);
                        }
                        break;
                        
                    case 'answer':
                        console.log(`Received answer from ${fromUserId}, current state: ${peerConnection.signalingState}`);
                        
                        if (peerConnection.signalingState === 'have-local-offer') {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                            this.processQueuedIceCandidates(fromUserId, peerConnection);
                        }
                        break;
                        
                    case 'ice-candidate':
                        if (candidate && candidate.candidate && candidate.sdpMid !== null && candidate.sdpMLineIndex !== null) {
                            if (peerConnection.remoteDescription) {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            } else {
                                console.log(`Queuing ICE candidate from ${fromUserId}`);
                                const queue = this.iceCandidateQueue.get(fromUserId) || [];
                                queue.push(candidate);
                                this.iceCandidateQueue.set(fromUserId, queue);
                            }
                        }
                        break;
                }
            }
        } catch (error) {
            console.error('Error handling signal:', error);
            this.pendingSignals.delete(signalKey);
        }
    }

    async processQueuedIceCandidates(peerId, peerConnection) {
        const queue = this.iceCandidateQueue.get(peerId);
        if (queue && queue.length > 0) {
            console.log(`Processing ${queue.length} queued ICE candidates for ${peerId}`);
            for (const candidate of queue) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Error adding queued ICE candidate:', error);
                }
            }
            this.iceCandidateQueue.set(peerId, []);
        }
    }

    sendSignal(toUserId, signal) {
        if (!this.db) {
            console.error('Cannot send signal: Firebase database not available');
            return;
        }

        signal.from = this.userId;
        signal.timestamp = Date.now();
        
        const signalRef = this.db.ref(`rooms/${this.roomId}/signals`).push();
        signalRef.set(signal);
        
        setTimeout(() => {
            signalRef.remove().catch(error => {
                console.log('Signal already removed:', error);
            });
        }, 30000);
    }

    handleRemoteStream(peerId, stream) {
        console.log(`Handling remote stream from ${peerId}`);
        
        if (!this.db) return;
        
        this.db.ref(`rooms/${this.roomId}/participants/${peerId}`).once('value').then(snapshot => {
            const participantData = snapshot.val();
            if (participantData) {
                if (this.userRole === 'student' && participantData.role === 'teacher') {
                    // Student receiving teacher's stream
                    this.teacherVideo.srcObject = stream;
                    this.teacherVideo.style.display = 'block';
                    this.teacherTitle.textContent = `${participantData.name}'s Screen`;
                    if (participantData.screenSharing) {
                        this.teacherTitle.textContent = `${participantData.name} - Screen Sharing`;
                    }
                } else if (this.userRole === 'teacher' && participantData.role === 'student') {
                    // Teacher receiving student's stream
                    this.showParticipantVideo(peerId, stream);
                }
            }
        }).catch(error => {
            console.error('Error checking participant data:', error);
        });
    }

    showParticipantVideo(peerId, stream) {
        let participantCard = document.getElementById(`participant-${peerId}`);
        
        if (!participantCard) {
            // Create participant card if it doesn't exist
            participantCard = document.createElement('div');
            participantCard.className = 'participant-card';
            participantCard.id = `participant-${peerId}`;
            
            if (!this.db) return;
            
            // Get participant data for name
            this.db.ref(`rooms/${this.roomId}/participants/${peerId}`).once('value').then(snapshot => {
                const participantData = snapshot.val();
                if (participantData) {
                    participantCard.innerHTML = `
                        <video class="participant-video" autoplay playsinline></video>
                        <div class="participant-info">
                            <span class="participant-name">${participantData.name}</span>
                            <div class="participant-status">
                                <span class="status-icon ${participantData.videoEnabled ? '' : 'status-muted'}">üìπ</span>
                                <span class="status-icon ${participantData.audioEnabled ? '' : 'status-muted'}">üé§</span>
                                ${participantData.handRaised ? '<span class="status-icon hand-raised">‚úã</span>' : ''}
                            </div>
                        </div>
                    `;
                    
                    const videoElement = participantCard.querySelector('.participant-video');
                    if (videoElement) {
                        videoElement.srcObject = stream;
                        videoElement.style.display = 'block';
                        videoElement.onloadedmetadata = () => {
                            videoElement.play().catch(e => console.log('Play error:', e));
                        };
                    }
                    
                    this.participantsGrid.appendChild(participantCard);
                    this.updateParticipantsCount();
                }
            });
        } else {
            // Update existing participant card
            const videoElement = participantCard.querySelector('.participant-video');
            if (videoElement) {
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
            }
        }
    }

    // Replace all video tracks in existing peer connections with screen share
    async replaceAllVideoTracks(newStream) {
        const videoTrack = newStream.getVideoTracks()[0];
        if (!videoTrack) return;

        for (const [peerId, peerConnection] of Object.entries(this.peers)) {
            try {
                const sender = peerConnection.getSenders().find(s => 
                    s.track && s.track.kind === 'video'
                );
                
                if (sender) {
                    await sender.replaceTrack(videoTrack);
                } else {
                    peerConnection.addTrack(videoTrack, newStream);
                }
            } catch (error) {
                console.error(`Error replacing track for peer ${peerId}:`, error);
            }
        }
    }

    // Switch all video tracks back to camera
    async switchBackToCamera() {
        if (!this.localStream) return;

        const cameraVideoTrack = this.localStream.getVideoTracks()[0];
        if (!cameraVideoTrack) return;

        for (const [peerId, peerConnection] of Object.entries(this.peers)) {
            try {
                const sender = peerConnection.getSenders().find(s => 
                    s.track && s.track.kind === 'video'
                );
                
                if (sender) {
                    await sender.replaceTrack(cameraVideoTrack);
                }
            } catch (error) {
                console.error(`Error switching to camera for peer ${peerId}:`, error);
            }
        }
    }

    // UI Management
    addParticipantToGrid(participantId, participantData) {
        if (document.getElementById(`participant-${participantId}`)) return;

        const participantCard = document.createElement('div');
        participantCard.className = 'participant-card';
        participantCard.id = `participant-${participantId}`;

        participantCard.innerHTML = `
            <div class="participant-placeholder">
                <div class="placeholder-content">
                    <div class="placeholder-icon">üë§</div>
                    <p>${participantData.name}</p>
                </div>
            </div>
            <div class="participant-info">
                <span class="participant-name">${participantData.name}</span>
                <div class="participant-status">
                    <span class="status-icon ${participantData.videoEnabled ? '' : 'status-muted'}">üìπ</span>
                    <span class="status-icon ${participantData.audioEnabled ? '' : 'status-muted'}">üé§</span>
                    ${participantData.handRaised ? '<span class="status-icon hand-raised">‚úã</span>' : ''}
                </div>
            </div>
        `;

        this.participantsGrid.appendChild(participantCard);
    }

    updateParticipantInGrid(participantId, participantData) {
        const participantCard = document.getElementById(`participant-${participantId}`);
        if (participantCard) {
            const statusIcons = participantCard.querySelectorAll('.status-icon');
            const videoIcon = statusIcons[0];
            const audioIcon = statusIcons[1];
            
            if (videoIcon) {
                videoIcon.classList.toggle('status-muted', !participantData.videoEnabled);
            }
            if (audioIcon) {
                audioIcon.classList.toggle('status-muted', !participantData.audioEnabled);
            }
            
            // Handle raise hand
            let handIcon = participantCard.querySelector('.hand-raised');
            if (participantData.handRaised && !handIcon) {
                const newHandIcon = document.createElement('span');
                newHandIcon.className = 'status-icon hand-raised';
                newHandIcon.textContent = '‚úã';
                participantCard.querySelector('.participant-status').appendChild(newHandIcon);
            } else if (!participantData.handRaised && handIcon) {
                handIcon.remove();
            }
        }
    }

    removeParticipantFromGrid(participantId) {
        const participantCard = document.getElementById(`participant-${participantId}`);
        if (participantCard) {
            participantCard.remove();
        }
    }

    updateParticipantsCount() {
        const count = document.querySelectorAll('.participant-card').length;
        this.participantsCount.textContent = count;
    }

    closePeerConnection(peerId) {
        if (this.peers[peerId]) {
            this.peers[peerId].close();
            delete this.peers[peerId];
            this.iceCandidateQueue.delete(peerId);
            console.log(`Closed connection with ${peerId}`);
        }
    }
            async toggleVideo() {
                if (!this.localStream) return;

                const videoTrack = this.localStream.getVideoTracks()[0];
                if (videoTrack) {
                    this.isVideoOn = !this.isVideoOn;
                    videoTrack.enabled = this.isVideoOn;
                    
                    this.updateVideoButton();
                    this.updateUserStatus();
                }
            }

            async toggleAudio() {
                if (!this.localStream) return;

                const audioTrack = this.localStream.getAudioTracks()[0];
                if (audioTrack) {
                    this.isAudioOn = !this.isAudioOn;
                    audioTrack.enabled = this.isAudioOn;
                    
                    this.updateAudioButton();
                    this.updateUserStatus();
                }
            }

    async toggleScreenShare() {
        if (this.userRole !== 'teacher') {
            alert('Only teachers can share their screen.');
            return;
        }

        try {
            if (!this.isScreenSharing) {
                this.screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: 'always' },
                    audio: true
                });

                await this.replaceAllVideoTracks(this.screenStream);
                this.isScreenSharing = true;

                if (!this.db) {
                    console.error('Cannot update screen share: Firebase not available');
                    return;
                }

                await this.db.ref(`rooms/${this.roomId}/screenShare`).set({
                    active: true,
                    teacherId: this.userId,
                    teacherName: this.userName,
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                });

                const videoTrack = this.screenStream.getVideoTracks()[0];
                videoTrack.onended = () => {
                    this.stopScreenShare();
                };

            } else {
                await this.stopScreenShare();
            }

            this.updateScreenShareButton();
            this.updateUserStatus();

        } catch (error) {
            console.error('Error sharing screen:', error);
        }
    }

    async stopScreenShare() {
        if (this.screenStream) {
            this.screenStream.getTracks().forEach(track => track.stop());
            this.screenStream = null;
        }

        await this.switchBackToCamera();
        this.isScreenSharing = false;

        if (!this.db) return;

        await this.db.ref(`rooms/${this.roomId}/screenShare`).set({
            active: false
        });
    }

    async toggleRaiseHand() {
        this.isHandRaised = !this.isHandRaised;
        this.updateRaiseHandButton();
        this.updateUserStatus();
    }

    handleScreenShareUpdate(snapshot) {
        const screenData = snapshot.val();
        if (screenData && screenData.active && screenData.teacherId !== this.userId) {
            this.screenSharingTeacherId = screenData.teacherId;
            if (this.userRole === 'student') {
                this.teacherTitle.textContent = `${screenData.teacherName} - Screen Sharing`;
            }
        } else if (!screenData || !screenData.active) {
            if (this.userRole === 'student') {
                this.teacherTitle.textContent = "Teacher's Screen";
            }
        }
    }

    updateVideoButton() {
        const icon = this.isVideoOn ? 'üìπ' : '‚ùå';
        const text = this.isVideoOn ? 'Stop Video' : 'Start Video';
        this.videoToggle.querySelector('.control-icon').textContent = icon;
        this.videoToggle.querySelector('.control-text').textContent = text;
        this.videoToggle.classList.toggle('control-active', this.isVideoOn);
    }

    updateAudioButton() {
        const icon = this.isAudioOn ? 'üé§' : 'üîá';
        const text = this.isAudioOn ? 'Mute' : 'Unmute';
        this.audioToggle.querySelector('.control-icon').textContent = icon;
        this.audioToggle.querySelector('.control-text').textContent = text;
        this.audioToggle.classList.toggle('control-active', this.isAudioOn);
    }

    updateScreenShareButton() {
        const icon = this.isScreenSharing ? 'üõë' : 'üñ•Ô∏è';
        const text = this.isScreenSharing ? 'Stop Share' : 'Share Screen';
        this.screenShareBtn.querySelector('.control-icon').textContent = icon;
        this.screenShareBtn.querySelector('.control-text').textContent = text;
        this.screenShareBtn.classList.toggle('control-active', this.isScreenSharing);
    }

    updateRaiseHandButton() {
        const text = this.isHandRaised ? 'Lower Hand' : 'Raise Hand';
        this.raiseHandBtn.querySelector('.control-text').textContent = text;
        this.raiseHandBtn.classList.toggle('control-active', this.isHandRaised);
    }

    async updateUserStatus() {
        if (!this.db) {
            console.error('Cannot update user status: Firebase not available');
            return;
        }

        const userRef = this.db.ref(`rooms/${this.roomId}/participants/${this.userId}`);
        await userRef.update({
            videoEnabled: this.isVideoOn,
            audioEnabled: this.isAudioOn,
            screenSharing: this.isScreenSharing,
            handRaised: this.isHandRaised,
            lastActive: firebase.database.ServerValue.TIMESTAMP
        });
    }

    async leaveRoom() {
        if (confirm('Are you sure you want to leave the classroom?')) {
            Object.keys(this.peers).forEach(peerId => {
                this.closePeerConnection(peerId);
            });

            if (this.localStream) {
                this.localStream.getTracks().forEach(track => track.stop());
            }
            if (this.screenStream) {
                this.screenStream.getTracks().forEach(track => track.stop());
            }

            if (this.participantsRef) this.participantsRef.off();
            if (this.signalsRef) this.signalsRef.off();
            if (this.screenShareRef) this.screenShareRef.off();

            if (this.db) {
                const userRef = this.db.ref(`rooms/${this.roomId}/participants/${this.userId}`);
                await userRef.remove();

                if (this.userRole === 'teacher' && this.isScreenSharing) {
                    await this.db.ref(`rooms/${this.roomId}/screenShare`).set({ active: false });
                }
            }

            location.reload();
        }
    }
}
        document.addEventListener('DOMContentLoaded', () => {
            window.virtualClassroom = new VirtualClassroom();
        });
    </script>
</body>
</html>